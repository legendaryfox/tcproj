<br />
<div class="map_filter" style="z-index: 1">
<%= form_tag map_path, :method => :get do %>
<center>
<strong>Filter By: </strong><br /><br />
<p>
<%= select_tag "category_id", options_from_collection_for_select(@categories, "id", "name", @selected_category.to_i), :include_blank => "All Categories" %>
<br /><br />
<%= submit_tag "Filter", :name => nil, :class => "btn primary span4" %>
<br /><br />
<small>(Currently showing <%= pluralize(@cbo_count, 'CBO') %> in <%= @category_name %>)</small>
</p>
</center>

<% end %>
</div>
 
<% if !signed_in_user? && @selected_category.nil? && !signed_in_cbo? %>

		<div id="modal-from-dom" class="modal hide fade in" style="display: block; width:347px; position: absolute; z-index: 100">
		    <div class="modal-header">
		    <a class="close" href="#">x</a>
		    <h3>Welcome!</h3>
		    </div>

		    <div class="modal-body">
		    <p>We're glad you're here. Feel free to browse around our site, and see how you can help your community!</p>
		    </div>

		    <div class="modal-footer">
		    <a class="close btn primary" href="#">Thanks!</a>
		    </div>
		</div>
		
<% end %>

<script>
	$(".close").click(function ( event ) {
      event.preventDefault();
      $("#modal-from-dom").hide();
    });
</script>



<div id="map_canvas" style="width: 100%; height: 100%;"></div>


<noscript><b>JavaScript must be enabled in order for you to use Google Maps.</b> 
  However, it seems JavaScript is either disabled or not supported by your browser. 
  To view Google Maps, enable JavaScript by changing your browser options, and then 
  try again.
</noscript>


<script type="text/javascript">
//<![CDATA[

if (GBrowserIsCompatible()) { 

  // A function to create the marker and set up the event window
  // Dont try to unroll this function. It has to be here for the function closure
  // Each instance of the function preserves the contends of a different instance
  // of the "marker" and "html" variables which will be needed later when the event triggers.    
  function createMarker(point,html) {
    var marker = new GMarker(point);


    GEvent.addListener(marker, "click", function() {
      marker.openInfoWindowHtml(html);
    });
    return marker;
  }

	function createIconMarker(point,html,options) {
		var marker = new GMarker(point, options);
		
		
		
		GEvent.addListener(marker, "click", function() {
			marker.openInfoWindowHtml(html);
		});
		return marker;
	}



  // Display the map, with some controls and set the initial location 
  var map = new GMap2(document.getElementById("map_canvas"));
  map.addControl(new GLargeMapControl());
  //map.addControl(new GMapTypeControl());
  //map.setCenter(new GLatLng(42.357778, -71.061667),13);
	map.setCenter(new GLatLng(<%= @centerLat %>, <%= @centerLng %>), 13);
	

	

	// SET UP CBO MARKERS

	// UNJOINED CBOS
	<% @unjoined_cboprofiles.each do |cboprofile| %>
		var point = new GLatLng(<%= cboprofile.latitude || @centerLat  %>, <%= cboprofile.longitude || @centerLng %>);
		var myIcon = new GIcon(G_DEFAULT_ICON);
		myIcon.image = "images/red_workdesk.png";
		myIcon.iconSize = new GSize(32, 37);
		myIcon.shadow = "images/shadow.png";
		myIcon.shadowSize = new GSize(51, 37);
		markerOptions = { 
			icon:myIcon,
			title: 'You are not part of this CBO.'
		};
		var marker = createIconMarker(point, '<div style="width:300px"> \
		<strong><%= link_to escape_javascript(cboprofile.name), cboprofile %></strong> - <%= cboprofile.cbo.email %> <br /> \
		<%= escape_javascript(cboprofile.description) %> <br />\
		<%= escape_javascript(cboprofile.full_address) %> <br /><\/div>', markerOptions)
		map.addOverlay(marker);
	<% end %>
	
	// JOINED CBOS
	<% @joined_cboprofiles.each do |cboprofile| %>
		var point = new GLatLng(<%= cboprofile.latitude || @centerLat  %>, <%= cboprofile.longitude || @centerLng %>);
		var myIcon = new GIcon(G_DEFAULT_ICON);
		myIcon.image = "images/green_workdesk.png";
		myIcon.iconSize = new GSize(32, 37);
		myIcon.shadow = "images/shadow.png";
		myIcon.shadowSize = new GSize(51, 37);
		markerOptions = { 
			icon:myIcon,
			title: 'You are a part of this CBO!'
		};
		var marker = createIconMarker(point, '<div style="width:300px"> \
		<strong><%= link_to escape_javascript(cboprofile.name), cboprofile %></strong> - <%= cboprofile.cbo.email %> <br /> \
		<%= escape_javascript(cboprofile.description) %> <br />\
		<%= escape_javascript(cboprofile.full_address) %> <br /><\/div>', markerOptions)
		map.addOverlay(marker);
	<% end %>
	
	
	
	// DRAW THE CENTER MARKER
	
	var point = new GLatLng(<%= @centerLat %>, <%= @centerLng %>);
	var myIcon = new GIcon(G_DEFAULT_ICON);
	myIcon.image = "images/smiley_happy.png";
	myIcon.iconSize = new GSize(32, 37)
	myIcon.shadow = "images/shadow.png";
	myIcon.shadowSize = new GSize(51, 37);
	markerOptions = { 
		icon:myIcon,
		title: '<%= @centerText %>'
	};
	//map.addOverlay(new GMarker(point, markerOptions));
	var marker = createIconMarker(point, '<%= @centerText %>', markerOptions);
	map.addOverlay(marker);
	
	


}

// display a warning if the browser was not compatible
else {
  alert("Sorry, the Google Maps API is not compatible with this browser");
}

</script>



		
		
		
		

